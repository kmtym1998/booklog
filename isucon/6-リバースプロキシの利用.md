# リバースプロキシの利用

<img width="680" alt="image" src="https://user-images.githubusercontent.com/54347899/178128027-3ac8d596-1ddd-459d-8f80-9bd7a11c026f.png">

- アプリケーションサーバに分散してリクエストを送ることで、大量のリクエスト・レスポンスをさばける
- アプリケーションサーバを水平スケーリングしてリバースプロキシすると 1 台あたりの負荷を減らせる
- コンテンツのキャッシュや HTTPS 通信の終端でパフォーマンス上有利に
- HTTP ヘッダの書き換え、IP 制限、ロギングなど

--

<img width="723" alt="image" src="https://user-images.githubusercontent.com/54347899/178128266-b7d0f015-dd53-47ce-b01b-e39d1f38a317.png">

- マルチプロセス・シングルスレッドだと、クライアントが 1 万超えたあたりでパフォーマンスが急落 (C10K 問題)
  - スレッドとプロセスについて:
    - https://webpia.jp/thread_process/
    - https://milestone-of-se.nesuke.com/sv-basic/architecture/cpu
- goroutine。軽量なスレッド
- Go のランタイムがプログラム起動時に CPU のコア数分のスレッドを生成する
- 並列化はアプリケーションコードを複雑化させるので、非効率
  - nginx などのリバースプロキシをアプリケーションの前段に置く
  - nginx もマルチプロセス・シングルスレッドで動く。C10K 問題には「イベント駆動」というアプローチで解決
  - 画像・CSS・JS などの静的ファイルの配信はリバースプロキシからやればいい

--

- nginx は設定ファイルを書くことでアップストリームにリクエストを転送したり、直接静的ファイルを配信できる
  - 設定ファイルには簡単なロジックなら書ける
    - lua-nginx-module, ngx-mruby みたいなものがあるらしい
- nginx の version は Mainline と Stable がある。production 環境では Stable を使おう

<!-- 6-3 の途中まで -->
