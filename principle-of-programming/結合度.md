# 4.1 結合度

## とは

- モジュール同士の関係の密接さを表す尺度
- レベルが 1 ~ 6。高いほど関係が薄く (=疎結合)、よいモジュール
- 結合度のレベルはモジュール間でデータがどのように受け渡されるかで判断

### 1. 内容結合

- モジュールの一部が共有されあっている
- モジュール内の外部公開していないデータを直接参照したり、命令を一部共有する場合
- 高水準言語にはない。アセンブラなどの低水準言語ではしばしば見られる
- 内容結合では変更が障害につながるケースが多い
- (低水準言語使わないし全然イメージできないが、やばそう)

### 2. 共通結合

- 共有域にあるデータを複数モジュールが参照する形式
  - いわゆるグローバル変数
- 👍
  - モジュール間のパラメータ渡しが減る
- 👎
  - 共有域のデータはモジュールのインターフェイス上に現れないので、コードの解読難易度が上がる
  - 共有域のデータはどんなモジュールからでも (たとえモジュールに無関係でも) その気になれば使える。堅牢でない
  - 共有域のデータを通じて他のモジュールと密結合になるので再利用性が下がる
- 多くの場面では短所が上回る。受け渡しのパラメータが多くなるなら、その設計がまず間違ってることを疑う

### 3. 外部結合

- 外部宣言したデータを共有
  - 例えば、public なメンバ変数
- 必要なデータだけを外部公開するので、(共通結合のように) 不必要なデータまで共有することはないので、共有結合より関係が薄くなる

### 4. 制御結合

- 呼び出し側が呼び出したいモジュールの制御を指示するパラメータを渡す
  - 例: https://speakerdeck.com/moriatsushi/liang-ikodotohahe-ka-enziniaxin-zu-yan-xiu-suraidogong-kai?slide=53
- 呼び出し側は、呼び出される側のモジュールのロジックを知っている必要がある
- 呼び出し側の凝集度が論理的強度になる (凝集度レベル 2)
- データの共有はしていないので、共有結合や外部結合より関係性は薄い

### 5. スタンプ結合

- 共有域にないデータ構造をモジュール間で受け渡す
  - 例: https://speakerdeck.com/moriatsushi/liang-ikodotohahe-ka-enziniaxin-zu-yan-xiu-suraidogong-kai?slide=54
- 受け渡すデータ構造の一部を利用しないことがある。不必要なデータも受け渡すことがある

### 6. データ結合

- スカラ型だけのデータ要素だけをパラメータとして渡す
  - https://speakerdeck.com/moriatsushi/liang-ikodotohahe-ka-enziniaxin-zu-yan-xiu-suraidogong-kai?slide=55
- パラメータを渡すだけでいいから、呼び出し側のコードは呼び出される側がブラックボックスとして扱うことができる
- 呼び出される側は機能的強度 (レベル MAX 凝集度) である必要がある
- スタンプ結合で渡しているデータが構造体でも、そのデータ全部を処理するならそれはデータ結合としてよい

## なぜ重要か？

- 密結合が良くない
- 密結合なモジュールが存在すると...
  - あるモジュールを変更したとき、結合するモジュールにも影響が出る
  - あるモジュールを利用するには、結合するモジュールも必要になるので、再利用性が低下する
  - コードが単独で理解できない。結合しているモジュール・グローバル変数まで見に行かないと

## どうやる？

- モジュールの独立性を高める。インターフェースはできるだけ低いレベルの結合度を目指す
- 具体的には...
  - データの受け渡しは引数で行う
  - データの置き場所はグローバル変数に置かない。一瞬しか使用しないならローカル変数で！
  - 引数で渡される値に応じて動作が変わるコードを書かない

### 関連

- ハイブリッド結合
  - (js の `indexOf` とか?)
- 結合の本数と方向も気にしようね
  - 他のモジュールと「たくさん」「双方向」に関係を持つモジュールは、結合度が高いモジュール同様デメリットが多い
- 冪等性と安全性
  - 冪等性: ある操作を何回行っても同じ結果が変えること
  - 安全性: 捜査対象の状態を変化させないこと
  - サーバに冪等性・安全性があるとクライアントはブラックボックス的にサービスを利用できる

## 所感

- 凝集度の高いコードがないと結合度が高いコードを書くのはおそらく難しいと思った

> 結合の本数と方向

- これも結構気にしないといけないような気がしたが、結合度レベルには含まれていないのが意外な感じ
- オニオンアーキテクチャが言わんとすることはなんとなくわかったような (わからない)
